# Foundry框架理论知识回顾
Foundry 是一个高性能的以太坊开发工具链，专注于智能合约的测试、部署和调试。其主要组成部分包括：</br>
Forge：Foundry的测试运行器和开发环境。用于编译、测试、部署智能合约，支持 Solidity 和 Yul。Forge提供了强大的单元测试框架，支持断言、模拟、Fuzz 测试等。</br>
Cast：命令行工具，用于与以太坊网络交互。可用于发送交易、调用合约、查询链上数据等，适合脚本化和自动化操作。</br>
Anvil：本地以太坊节点模拟器，支持快速启动本地链、调试合约、测试交易等，用于快速开发和测试。</br>
Chisel：字节码分析和优化工具，帮助开发者分析合约的字节码结构和性能瓶颈。</br>
Foundry的优势在于极快的编译速度、丰富的测试功能、易于集成CI/CD流程，以及对Gas消耗的详细分析能力。
# Foundry框架实践操作
## 1.搭建环境与创建项目
```shell
forge init my_foundry
cd my_foundry
```
## 2.编写智能合约
创建合约文件 src/Arithmetic.sol
## 3.编写测试用例
创建测试文件 test/Arithmetic.t.sol
## 4.运行测试用例
```shell
forge test --gas-report
```
生成Gas消耗报告
内容如下所示：   
``` shell
Ran 3 tests for test/Arithmetic.t.sol:ArithmeticTest
[PASS] testAdd() (gas: 55922)
[PASS] testSub() (gas: 55991)
[FAIL: Error != expected error: Underflow protection != Subtraction underflow] testSubUnderflow() (gas: 30901)
Suite result: FAILED. 2 passed; 1 failed; 0 skipped; finished in 2.25ms (1.49ms CPU time)

╭----------------------------------------+-----------------+-------+--------+-------+---------╮
| src/Arithmetic.sol:Arithmetic Contract |                 |       |        |       |         |
+=============================================================================================+
| Deployment Cost                        | Deployment Size |       |        |       |         |
|----------------------------------------+-----------------+-------+--------+-------+---------|
| 251624                                 | 949             |       |        |       |         |
|----------------------------------------+-----------------+-------+--------+-------+---------|
|                                        |                 |       |        |       |         |
|----------------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                          | Min             | Avg   | Median | Max   | # Calls |
|----------------------------------------+-----------------+-------+--------+-------+---------|
| add                                    | 46333           | 46333 | 46333  | 46333 | 1       |
|----------------------------------------+-----------------+-------+--------+-------+---------|
| sub                                    | 22245           | 34324 | 34324  | 46403 | 2       |
╰----------------------------------------+-----------------+-------+--------+-------+---------╯
```
## 5.实施Gas优化策略
优化版本 1：ArithmeticOptimized1.sol  减少存储写入和事件触发
``` shell
Ran 3 tests for test/ArithmeticOptimized1.t.sol";.t.sol:ArithmeticTest
[PASS] testAdd() (gas: 53984)
[PASS] testSub() (gas: 31761)
[FAIL: Error != expected error: Underflow not allowed != Subtraction underflow] testSubUnderflow() (gas: 30901)
Suite result: FAILED. 2 passed; 1 failed; 0 skipped; finished in 2.35ms (1.15ms CPU time)

╭------------------------------------------------------------+-----------------+-----+--------+-----+---------╮
| src/ArithmeticOptimized1.sol:ArithmeticOptimized1 Contract |                 |     |        |     |         |
+=============================================================================================================+
| Deployment Cost                                            | Deployment Size |     |        |     |         |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| 212704                                                     | 769             |     |        |     |         |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
|                                                            |                 |     |        |     |         |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| Function Name                                              | Min             | Avg | Median | Max | # Calls |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| add                                                        | 44395           | 44395 | 44395  | 44395 | 1       |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| sub                                                        | 22173           | 22209 | 22209  | 22245 | 2      |
╰------------------------------------------------------------+-----------------+-----+--------+-----+---------╯
```
优化版本 2：ArithmeticOptimized2.sol  使用返回值而非存储，添加纯函数版本
``` shell
Ran 3 tests for test/ArithmeticOptimized2.t.sol:ArithmeticOptimized2Test
[PASS] testAdd() (gas: 10513)
[PASS] testSub() (gas: 10582)
[FAIL: Error != expected error: Underflow not allowed != Subtraction underflow] testSubUnderflow() (gas: 9555)
Suite result: FAILED. 2 passed; 1 failed; 0 skipped; finished in 2.53ms (1.06ms CPU time)
╭------------------------------------------------------------+-----------------+-----+--------+-----+---------╮
| src/ArithmeticOptimized2.sol:ArithmeticOptimized2 Contract |                 |     |        |     |         |
+=============================================================================================================+
| Deployment Cost                                            | Deployment Size |     |        |     |         |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| 222216                                                     | 813             |     |        |     |         |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
|                                                            |                 |     |        |     |         |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| Function Name                                              | Min             | Avg | Median | Max | # Calls |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| add                                                        | 926             | 926 | 926    | 926 | 1       |
|------------------------------------------------------------+-----------------+-----+--------+-----+---------|
| sub                                                        | 901             | 948 | 948    | 996 | 2       |
╰------------------------------------------------------------+-----------------+-----+--------+-----+---------╯
```